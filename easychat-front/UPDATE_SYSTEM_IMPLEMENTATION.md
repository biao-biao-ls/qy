# è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿå®ç°æ€»ç»“

## æ¦‚è¿°

æˆåŠŸå®ç°äº†å®Œæ•´çš„è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ›´æ–°æ£€æŸ¥ã€ä¸‹è½½ã€å®‰è£…ã€å›æ»šå’Œæ—¥å¿—è®°å½•åŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæä¾›äº†å¯é çš„æ›´æ–°æœºåˆ¶å’Œç”¨æˆ·å‹å¥½çš„ç•Œé¢ã€‚

## æ ¸å¿ƒç»„ä»¶

### 1. UpdateService (æ›´æ–°æœåŠ¡)
**æ–‡ä»¶**: `src/main/services/UpdateService.ts`

**åŠŸèƒ½**:
- é›†æˆ `electron-updater` è¿›è¡Œè‡ªåŠ¨æ›´æ–°
- æ”¯æŒè‡ªå®šä¹‰æ›´æ–°æœåŠ¡å™¨æ£€æŸ¥
- å¤„ç†æ›´æ–°æ£€æŸ¥ã€ä¸‹è½½å’Œå®‰è£…æµç¨‹
- ç®¡ç†æ›´æ–°è¿›åº¦å’ŒçŠ¶æ€é€šçŸ¥

**ä¸»è¦æ–¹æ³•**:
- `checkForUpdates()` - æ£€æŸ¥æ›´æ–°
- `downloadUpdate()` - ä¸‹è½½æ›´æ–°
- `installUpdate()` - å®‰è£…æ›´æ–°å¹¶é‡å¯
- `checkCustomUpdate()` - æ£€æŸ¥è‡ªå®šä¹‰æ›´æ–°æœåŠ¡å™¨

### 2. UpdateLogService (æ›´æ–°æ—¥å¿—æœåŠ¡)
**æ–‡ä»¶**: `src/main/services/UpdateLogService.ts`

**åŠŸèƒ½**:
- è®°å½•æ‰€æœ‰æ›´æ–°ç›¸å…³çš„æ“ä½œæ—¥å¿—
- æä¾›æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- æ”¯æŒæ—¥å¿—å¯¼å‡ºå’Œæ¸…ç†åŠŸèƒ½
- è·Ÿè¸ªæ›´æ–°æˆåŠŸç‡å’Œé”™è¯¯ä¿¡æ¯

**ä¸»è¦æ–¹æ³•**:
- `logCheck()` - è®°å½•æ›´æ–°æ£€æŸ¥
- `logDownload()` - è®°å½•æ›´æ–°ä¸‹è½½
- `logInstall()` - è®°å½•æ›´æ–°å®‰è£…
- `logError()` - è®°å½•æ›´æ–°é”™è¯¯
- `getLogs()` - è·å–æ›´æ–°æ—¥å¿—
- `getStatistics()` - è·å–ç»Ÿè®¡ä¿¡æ¯

### 3. UpdateRollbackService (æ›´æ–°å›æ»šæœåŠ¡)
**æ–‡ä»¶**: `src/main/services/UpdateRollbackService.ts`

**åŠŸèƒ½**:
- è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬å¤‡ä»½
- æ”¯æŒæ›´æ–°å¤±è´¥æ—¶çš„å›æ»šæ“ä½œ
- ç®¡ç†å¤šä¸ªç‰ˆæœ¬å¤‡ä»½
- æä¾›å¤‡ä»½éªŒè¯å’Œæ¸…ç†åŠŸèƒ½

**ä¸»è¦æ–¹æ³•**:
- `createBackup()` - åˆ›å»ºç‰ˆæœ¬å¤‡ä»½
- `rollback()` - æ‰§è¡Œå›æ»šæ“ä½œ
- `getAvailableBackups()` - è·å–å¯ç”¨å¤‡ä»½
- `deleteBackup()` - åˆ é™¤å¤‡ä»½

### 4. UpdateManager (æ›´æ–°ç®¡ç†å™¨)
**æ–‡ä»¶**: `src/main/managers/UpdateManager.ts`

**åŠŸèƒ½**:
- åè°ƒæ•´ä¸ªæ›´æ–°æ£€æŸ¥å’Œä¸‹è½½æµç¨‹
- æ”¯æŒè‡ªåŠ¨æ›´æ–°æ£€æŸ¥å’Œæ‰‹åŠ¨æ›´æ–°æ£€æŸ¥
- å¤„ç†ä¸åŒç±»å‹çš„æ›´æ–°æç¤º
- ç®¡ç†æ›´æ–°çª—å£çš„æ˜¾ç¤º

**ä¸»è¦æ–¹æ³•**:
- `startAutoCheck()` - å¯åŠ¨è‡ªåŠ¨æ›´æ–°æ£€æŸ¥
- `checkForUpdates()` - æ‰‹åŠ¨æ£€æŸ¥æ›´æ–°
- `startDownload()` - å¼€å§‹ä¸‹è½½æ›´æ–°
- `installUpdate()` - å®‰è£…æ›´æ–°

### 5. UpdateWindow (æ›´æ–°çª—å£)
**æ–‡ä»¶**: `src/main/windows/UpdateWindow.ts`

**åŠŸèƒ½**:
- ç®¡ç†æ›´æ–°æç¤ºçª—å£
- æ”¯æŒå¤šç§æ›´æ–°çª—å£ç±»å‹ï¼ˆæ™®é€šæ›´æ–°ã€å¼ºåˆ¶æ›´æ–°ã€ä¸‹è½½è¿›åº¦ï¼‰
- å¤„ç†ç”¨æˆ·ç¡®è®¤å’Œå–æ¶ˆæ“ä½œ

**çª—å£ç±»å‹**:
- `update-tip` - æ™®é€šæ›´æ–°æç¤º
- `force-update` - å¼ºåˆ¶æ›´æ–°æç¤º
- `download-progress` - ä¸‹è½½è¿›åº¦çª—å£

### 6. UpdateTipPage (æ›´æ–°æç¤ºé¡µé¢)
**æ–‡ä»¶**: `src/renderer/src/pages/updateTip/UpdateTipPage.tsx`

**åŠŸèƒ½**:
- æ¸²æŸ“æ›´æ–°æç¤ºç•Œé¢
- æ˜¾ç¤ºæ›´æ–°ä¿¡æ¯å’Œè¿›åº¦
- å¤„ç†ç”¨æˆ·äº¤äº’

## IPC æ¥å£

### æ›´æ–°æ“ä½œ
- `update:check` - æ£€æŸ¥æ›´æ–°
- `update:download` - ä¸‹è½½æ›´æ–°
- `update:install` - å®‰è£…æ›´æ–°
- `update:get-version` - è·å–å½“å‰ç‰ˆæœ¬
- `update:check-custom` - æ£€æŸ¥è‡ªå®šä¹‰æ›´æ–°

### æ—¥å¿—å’Œç»Ÿè®¡
- `update:get-logs` - è·å–æ›´æ–°æ—¥å¿—
- `update:get-statistics` - è·å–æ›´æ–°ç»Ÿè®¡
- `update:export-logs` - å¯¼å‡ºæ›´æ–°æ—¥å¿—

### å¤‡ä»½å’Œå›æ»š
- `update:get-backups` - è·å–å¯ç”¨å¤‡ä»½
- `update:create-backup` - åˆ›å»ºå¤‡ä»½
- `update:rollback` - æ‰§è¡Œå›æ»š
- `update:delete-backup` - åˆ é™¤å¤‡ä»½

### çª—å£æ“ä½œ
- `update-window:get-options` - è·å–çª—å£é€‰é¡¹
- `update-window:confirm` - ç¡®è®¤æ›´æ–°
- `update-window:cancel` - å–æ¶ˆæ›´æ–°
- `update-window:close` - å…³é—­çª—å£

## é…ç½®

### electron-updater é…ç½®
```json
{
  "publish": [
    {
      "provider": "generic",
      "url": "https://test-static.jlcpcb.com/app_version/package/windows",
      "useMultipleRangeRequest": false
    },
    {
      "provider": "generic", 
      "url": "https://test-static.jlcpcb.com/app_version/package/mac/intel",
      "useMultipleRangeRequest": false
    },
    {
      "provider": "generic",
      "url": "https://test-static.jlcpcb.com/app_version/package/mac/arm", 
      "useMultipleRangeRequest": false
    }
  ]
}
```

### è‡ªåŠ¨æ›´æ–°è®¾ç½®
- è‡ªåŠ¨æ£€æŸ¥é—´éš”ï¼š4å°æ—¶
- å¯åŠ¨å»¶è¿Ÿæ£€æŸ¥ï¼š5ç§’
- æ”¯æŒå¼ºåˆ¶æ›´æ–°å’Œå¯é€‰æ›´æ–°
- è‡ªåŠ¨ä¸‹è½½ï¼šç¦ç”¨ï¼ˆè®©ç”¨æˆ·é€‰æ‹©ï¼‰
- é€€å‡ºæ—¶è‡ªåŠ¨å®‰è£…ï¼šå¯ç”¨

## æ–‡ä»¶ç»“æ„

```
src/main/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ UpdateService.ts          # æ ¸å¿ƒæ›´æ–°æœåŠ¡
â”‚   â”œâ”€â”€ UpdateLogService.ts       # æ›´æ–°æ—¥å¿—æœåŠ¡
â”‚   â””â”€â”€ UpdateRollbackService.ts  # æ›´æ–°å›æ»šæœåŠ¡
â”œâ”€â”€ managers/
â”‚   â””â”€â”€ UpdateManager.ts          # æ›´æ–°ç®¡ç†å™¨
â””â”€â”€ windows/
    â””â”€â”€ UpdateWindow.ts           # æ›´æ–°çª—å£ç®¡ç†

src/renderer/
â”œâ”€â”€ updateTip.html                # æ›´æ–°æç¤ºé¡µé¢HTML
â””â”€â”€ src/pages/updateTip/
    â”œâ”€â”€ main.tsx                  # é¡µé¢å…¥å£
    â””â”€â”€ UpdateTipPage.tsx         # æ›´æ–°æç¤ºç»„ä»¶
```

## æ•°æ®å­˜å‚¨

### æ›´æ–°æ—¥å¿—
- æ–‡ä»¶ï¼š`{userData}/update-logs.json`
- æœ€å¤§æ¡ç›®ï¼š1000æ¡
- åŒ…å«ï¼šæ£€æŸ¥ã€ä¸‹è½½ã€å®‰è£…ã€é”™è¯¯ã€å›æ»šè®°å½•

### æ›´æ–°ç»Ÿè®¡
- æ–‡ä»¶ï¼š`{userData}/update-statistics.json`
- ç»Ÿè®¡ï¼šæ€»æ£€æŸ¥æ¬¡æ•°ã€ä¸‹è½½æ¬¡æ•°ã€å®‰è£…æ¬¡æ•°ã€é”™è¯¯æ¬¡æ•°ã€å›æ»šæ¬¡æ•°

### ç‰ˆæœ¬å¤‡ä»½
- ç›®å½•ï¼š`{userData}/version-backups/`
- æ–‡ä»¶ï¼š`{userData}/version-backups.json`
- æœ€å¤§å¤‡ä»½ï¼š5ä¸ªç‰ˆæœ¬

## ä¸»è¦ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½
1. **è‡ªåŠ¨æ›´æ–°æ£€æŸ¥** - å®šæœŸæ£€æŸ¥æ–°ç‰ˆæœ¬
2. **æ‰‹åŠ¨æ›´æ–°æ£€æŸ¥** - ç”¨æˆ·ä¸»åŠ¨æ£€æŸ¥æ›´æ–°
3. **è‡ªå®šä¹‰æ›´æ–°æœåŠ¡å™¨** - æ”¯æŒè‡ªå®šä¹‰APIæ£€æŸ¥
4. **æ›´æ–°ä¸‹è½½** - å¸¦è¿›åº¦æ˜¾ç¤ºçš„ä¸‹è½½åŠŸèƒ½
5. **å®‰å…¨å®‰è£…** - è‡ªåŠ¨å¤‡ä»½å’Œå®‰è£…æ›´æ–°
6. **å¼ºåˆ¶æ›´æ–°** - æ”¯æŒå¼ºåˆ¶ç”¨æˆ·æ›´æ–°
7. **æ›´æ–°å›æ»š** - å¤±è´¥æ—¶å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬
8. **è¯¦ç»†æ—¥å¿—** - å®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•
9. **ç»Ÿè®¡ä¿¡æ¯** - æ›´æ–°æˆåŠŸç‡ç»Ÿè®¡
10. **ç”¨æˆ·ç•Œé¢** - å‹å¥½çš„æ›´æ–°æç¤ºç•Œé¢

### ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹
- **ç±»å‹å®‰å…¨** - å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- **æ¨¡å—åŒ–è®¾è®¡** - æ¸…æ™°çš„æœåŠ¡åˆ†ç¦»
- **é”™è¯¯å¤„ç†** - å®Œå–„çš„é”™è¯¯æ•è·å’Œå¤„ç†
- **æ—¥å¿—è®°å½•** - è¯¦ç»†çš„æ“ä½œæ—¥å¿—
- **é…ç½®çµæ´»** - æ”¯æŒå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒé…ç½®
- **å¹³å°å…¼å®¹** - æ”¯æŒWindowsã€macOSã€Linux

## ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨è‡ªåŠ¨æ›´æ–°
```typescript
// åœ¨ä¸»è¿›ç¨‹ä¸­
const updateManager = UpdateManager.getInstance()
await updateManager.initialize()
updateManager.setMainWindow(mainWindow)
updateManager.startAutoCheck()
```

### æ‰‹åŠ¨æ£€æŸ¥æ›´æ–°
```typescript
// åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­
const result = await electronAPI.ipc.invoke('update:check')
```

### è·å–æ›´æ–°æ—¥å¿—
```typescript
// åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­
const logs = await electronAPI.ipc.invoke('update:get-logs', 50)
```

### æ‰§è¡Œå›æ»š
```typescript
// åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­
const result = await electronAPI.ipc.invoke('update:rollback', {
  targetVersion: '1.0.12',
  createBackup: true
})
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **æ›´æ–°æ£€æŸ¥å¤±è´¥** - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæ›´æ–°æœåŠ¡å™¨URL
2. **ä¸‹è½½å¤±è´¥** - æ£€æŸ¥ç£ç›˜ç©ºé—´å’Œç½‘ç»œç¨³å®šæ€§
3. **å®‰è£…å¤±è´¥** - æ£€æŸ¥æ–‡ä»¶æƒé™å’Œé˜²ç—…æ¯’è½¯ä»¶
4. **å›æ»šå¤±è´¥** - æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§

### è°ƒè¯•æ–¹æ³•
1. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š`{userData}/logs/app.log`
2. æŸ¥çœ‹æ›´æ–°æ—¥å¿—ï¼š`{userData}/update-logs.json`
3. æ£€æŸ¥å¤‡ä»½çŠ¶æ€ï¼š`{userData}/version-backups.json`
4. å¯ç”¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º

## æ€»ç»“

æ›´æ–°ç³»ç»Ÿå·²æˆåŠŸè¿ç§»å¹¶å¢å¼ºï¼Œæä¾›äº†æ¯”åŸç³»ç»Ÿæ›´åŠ å®Œå–„çš„åŠŸèƒ½ï¼š
- ç®€åŒ–äº†æ›´æ–°æµç¨‹ï¼Œæé«˜äº†ç”¨æˆ·ä½“éªŒ
- å¢åŠ äº†å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œç»Ÿè®¡åŠŸèƒ½
- å®ç°äº†å¯é çš„å›æ»šæœºåˆ¶
- æä¾›äº†çµæ´»çš„é…ç½®é€‰é¡¹
- é‡‡ç”¨äº†ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆå’Œæ¶æ„

ç³»ç»Ÿç°åœ¨å¯ä»¥å®‰å…¨ã€å¯é åœ°å¤„ç†åº”ç”¨ç¨‹åºçš„è‡ªåŠ¨æ›´æ–°ï¼ŒåŒæ—¶ä¸ºç”¨æˆ·æä¾›äº†é€æ˜çš„æ›´æ–°è¿‡ç¨‹å’Œå®Œæ•´çš„æ§åˆ¶æƒã€‚